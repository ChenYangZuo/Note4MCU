# 6.1 中断系统

## 6.1.1 中断概述

```flow
step1=>start: 执行主程序
step2=>operation: 执行一条指令
step3=>condition: 是否有中断请求
step4=>operation: 取下一条指令
step5=>operation: 关中断，保护现场，开中断
step8=>operation: 中断服务
step9=>operation: 关中断，恢复现场，开中断
step12=>end: 返回断点

step1->step2->step3
step3(no)->step4(top)->step2
step3(yes)->step5->step8->step9->step12
```

## 6.1.2 中断源

![image-20220306171504664](pic/image-20220306171504664.png)

### 一、外部中断源

$\overline {INT0}$与$\overline {INT1}$

电平方式与脉冲方式

### 二、定时/计数器中断源

计数溢出时产生中断

### 三、串行口中断

串口完成一帧信息后将发送或接受中断标志位置1

## 6.1.3 中断控制

### 一、TCON

| 位地址 | 8FH  | 8DH  | 8BH  | 8AH  | 89H  | 88H  |
| :----: | :--: | :--: | :--: | :--: | :--: | :--: |
| 位符号 | TF1  | TF0  | IE1  | IT1  | IE0  | IT0  |

#### 1.IE0/IE1

外部中断有效时置1，进入中断服务后自动置0

#### 2.IT0/IT1

为0时外部中断电平触发，为1时外部中断脉冲触发

#### 3.TF0/TF1

定时/计数器溢出时置1，进入中断服务后自动置0

### 二、SCON

| 位地址 | 99H  | 98H  |
| :----: | :--: | :--: |
| 位符号 |  TI  |  RI  |

#### 1.TI

串口发送完一帧信息后自动置1，进入中断服务后手动置0

#### 2.RI

串口接收完一帧信息后自动置1，进入中断服务后手动置0

### 三、IE

| 位地址 | 0AFH | 0AEH | 0ADH | 0ACH | 0ABH | 0AAH | 0A9H | 0A8H |
| :----: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| 位符号 |  EA  |  -   |  -   |  ES  | ET1  | EX1  | ET0  | EX0  |

#### 1.EA

中断总开关，高电平有效

#### 2.EX0/EX1

外部中断开关，高电平有效

#### 3.ET0/ET1

定时/计数器中断开关，高电平有效

#### 4.ES

串口中断开关，高电平有效

### 四、IP

| 位地址 | 0BFH | 0BEH | 0BDH | 0BCH | 0BBH | 0BAH | 0B9H | 0B8H |
| :----: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| 位符号 |  -   |  -   |  -   |  PS  | PT1  | PX1  | PT0  | PX0  |

为0时为低优先级，1时为高优先级

#### 1.PX0/PX1

外部中断优先级设定

#### 2.PT0/PT1

定时/计数器中断优先级设定

#### 3.PS

串口中断优先级设定

#### 响应原则

高优先级可打断低优先级，反之不可

同级不能嵌套

同级同时出现响应顺序：外部0 -> 定时器0 -> 外部1 -> 定时器1 -> 串口

## 6.1.4 中断响应过程

### 一、中断采样

### 二、中断标志位查询

![image-20220306175113334](pic/image-20220306175113334.png)

### 三、中断响应

硬件生成长调用指令，将PC压栈后将中断入口送入PC，中断入口地址放置无条件转移指令

### 四、中断响应时间

## 6.1.5 中断请求的撤除

### 一、定时/计数器中断

响应后硬件自动撤除

### 二、外部中断

#### 1.脉冲方式

响应后硬件自动撤除

#### 2.电平方式

标志位在响应后硬件自动撤除

需要手动把外部中断输入端置1

### 三、串行中断

在中断服务内撤除

## 6.1.6 中断程序设计

**中断初始化**

1. CPU开关中断
2. 设置中断源开关
3. 设置中断优先级
4. 使用外部中断时设置电平/脉冲触发

### 一、汇编语言

外部中断时将开关状态反映至LED上

![image-20220306195328482](pic/image-20220306195328482-16465676097401.png)

```assembly
		ORG 0000H
		AJMP MAIN		;无条件转移
		
		ORG 0003H
		AJMP SER		;指向中断服务函数
		
		ORG 0030H
MAIN:	MOV P1,#0FH		;输出高电平保持LED熄灭
		SETB IT0		;外部中断脉冲触发
		SETB EX0		;允许外部中断
		SETB EA			;打开中断总开关
		AJMP $			;阻塞
SER:	MOV P1,#0FH		;输出高电平保持LED熄灭，且防止读取IO时大短路
		MOV A,P1		;读取IO状态
		CPL A			;取反
		ANL A,#0FH		;屏蔽A高半字节
		SWAP A			;交换高低半字节
		MOV P1,A		;输出
		RETI			;中断返回
```

### 二、C语言

```c
#include<reg51.h>
void int0() interrupt 0{
    P1 = 0x0f;
    P1<<=4;
    ~P1
}
main(){
    EA = 1;
    EX0 = 1;
    IT0 = 1;
    while(1);
}
```

## 6.1.7 外部中断源的扩展

### 一、利用定时器扩展外部中断源

将定时器装载值设置为0FFH，外部中断接入技术输入端

### 二、利用硬件申请软件查询拓展外部中断源

![image-20220306200946738](pic/image-20220306200946738.png)

利用线或功能触发中断，读取IO判断中断源



# 6.2 定时/计数器

## 6.2.1

## 6.2.2

## 6.2.3

## 6.2.4

## 6.2.5



# 6.3 串行通信口

## 6.3.1

## 6.3.2

## 6.3.3

## 6.3.4